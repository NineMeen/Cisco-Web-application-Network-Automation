{% extends "base.html" %}
{% block content %}
<style>
    .acl-name {
        cursor: pointer;
        padding: 10px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    
    .acl-name:hover {
        background-color: #e0e0e0;
    }
    
    .acl-rules {
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
    }
    </style>
<h1>Configure ACL</h1>
<form id="acl_form" method="POST">
    <div class="mb-3">
        <label for="device_id" class="form-label">Select Device</label>
        <select class="form-select" id="device_id" name="device_id" required>
            {% for device in devices %}
                <option value="{{ device[0] }}">{{ device[1] }} ({{ device[2] }})</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="acl_name" class="form-label">ACL Name</label>
        <input type="text" class="form-control" id="acl_name" name="acl_name" required>
    </div>
    <div class="mb-3">
        <label for="action" class="form-label">Action</label>
        <select class="form-select" id="action" name="action" required>
            <option value="permit">Permit</option>
            <option value="deny">Deny</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="protocol" class="form-label">Protocol</label>
        <select class="form-select" id="protocol" name="protocol" required>
            <option value="ip">IP</option>
            <option value="tcp">TCP</option>
            <option value="udp">UDP</option>
            <option value="icmp">ICMP</option>
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Source IP</label>
        <div class="input-group">
            <select class="form-select" id="source_type" name="source_type">
                <option value="any">Any</option>
                <option value="host">Host</option>
                <option value="network">Network</option>
            </select>
            <input type="text" class="form-control" id="source_ip" name="source_ip" placeholder="IP address" style="display:none;">
            <input type="text" class="form-control" id="source_wildcard" name="source_wildcard" placeholder="Wildcard mask" style="display:none;">
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Destination IP</label>
        <div class="input-group">
            <select class="form-select" id="destination_type" name="destination_type">
                <option value="any">Any</option>
                <option value="host">Host</option>
                <option value="network">Network</option>
            </select>
            <input type="text" class="form-control" id="destination_ip" name="destination_ip" placeholder="IP address" style="display:none;">
            <input type="text" class="form-control" id="destination_wildcard" name="destination_wildcard" placeholder="Wildcard mask" style="display:none;">
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Add ACL Rule</button>
</form>

<div id="acl_list_container" class="mt-4">
    <h2>ACL List</h2>
    <ul id="acl_list" class="list-group">
        <!-- ACL names will be dynamically added here -->
    </ul>
</div>




<script>
document.addEventListener('DOMContentLoaded', function() {
    const deviceSelect = document.getElementById('device_id');
    const aclForm = document.getElementById('acl_form');
    const aclList = document.getElementById('acl_list');

    let aclExpandedState = {};  // Object to store expanded state of each ACL

function updateACLList() {
    const deviceId = deviceSelect.value;
    fetch(`/get_acl_rules?device_id=${deviceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                aclList.innerHTML = '';
                for (const [aclName, rules] of Object.entries(data.acl_groups)) {
                    const aclDiv = document.createElement('div');
                    aclDiv.className = 'acl-item mb-3';
                    const isExpanded = aclExpandedState[aclName] || false;
                    aclDiv.innerHTML = `
                        <h3 class="acl-name" data-acl="${aclName}">
                            ${aclName} <span class="badge bg-secondary">${rules.length} rules</span>
                        </h3>
                        <div class="acl-rules" style="display: ${isExpanded ? 'block' : 'none'};">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Sequence</th>
                                        <th>Action</th>
                                        <th>Protocol</th>
                                        <th>Source IP</th>
                                        <th>Destination IP</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rules.map((rule, index) => `
                                        <tr>
                                            <td>${rule.sequence}</td>
                                            <td>${rule.action}</td>
                                            <td>${rule.protocol}</td>
                                            <td>${rule.source_ip}</td>
                                            <td>${rule.destination_ip}</td>
                                            <td>
                                                ${index > 0 ? `<button class="btn btn-sm btn-secondary move-up" data-acl="${aclName}" data-sequence="${rule.sequence}">▲</button>` : ''}
                                                ${index < rules.length - 1 ? `<button class="btn btn-sm btn-secondary move-down" data-acl="${aclName}" data-sequence="${rule.sequence}">▼</button>` : ''}
                                                <button class="btn btn-sm btn-danger delete-rule" data-acl="${aclName}" data-sequence="${rule.sequence}">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    aclList.appendChild(aclDiv);
                }
                addEventListeners();
            } else {
                console.error('Error fetching ACL rules:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function addEventListeners() {
    const aclNames = document.querySelectorAll('.acl-name');
    const moveUpButtons = document.querySelectorAll('.move-up');
    const moveDownButtons = document.querySelectorAll('.move-down');
    const deleteButtons = document.querySelectorAll('.delete-rule');

    aclNames.forEach(aclName => {
        aclName.addEventListener('click', function() {
            const aclNameValue = this.getAttribute('data-acl');
            const rulesDiv = this.nextElementSibling;
            aclExpandedState[aclNameValue] = !aclExpandedState[aclNameValue];
            rulesDiv.style.display = aclExpandedState[aclNameValue] ? 'block' : 'none';
        });
    });

    moveUpButtons.forEach(button => {
        button.addEventListener('click', function() {
            const aclName = this.getAttribute('data-acl');
            const sequence = this.getAttribute('data-sequence');
            moveRule(aclName, sequence, 'up');
        });
    });

    moveDownButtons.forEach(button => {
        button.addEventListener('click', function() {
            const aclName = this.getAttribute('data-acl');
            const sequence = this.getAttribute('data-sequence');
            moveRule(aclName, sequence, 'down');
        });
    });

    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const aclName = this.getAttribute('data-acl');
            const sequence = this.getAttribute('data-sequence');
            if (confirm('Are you sure you want to delete this rule?')) {
                deleteRule(aclName, sequence);
            }
        });
    });
}

function moveRule(aclName, sequence, direction) {
    const deviceId = deviceSelect.value;
    const formData = new FormData();
    formData.append('device_id', deviceId);
    formData.append('acl_name', aclName);
    formData.append('sequence', sequence);
    formData.append('direction', direction);

    fetch('/move_rule', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            updateACLList();
        } else {
            console.error('Error moving rule:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
function deleteRule(aclName, sequence) {
    const deviceId = deviceSelect.value;
    const formData = new FormData();
    formData.append('device_id', deviceId);
    formData.append('acl_name', aclName);
    formData.append('sequence', sequence);

    fetch('/delete_acl_rule', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log(data.message);
            updateACLList();  // This will now preserve the expanded/collapsed state
        } else {
            console.error('Error deleting rule:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

    deviceSelect.addEventListener('change', updateACLList);

    // Initial load of ACL list
    updateACLList();
});
</script> 
{% endblock %}