{% extends "base.html" %}
{% block content %}
<style>
    .delete-acl-button {
        margin-right: 5px;
        margin-bottom: 5px;
    }
    </style>
<h1>Configure and View ACL</h1>
<form id="acl_form" method="POST" action="{{ url_for('router_acl_config') }}">
    <div class="mb-3">
        <label for="device_id" class="form-label">Select Device</label>
        <select class="form-select" id="device_id" name="device_id" required>
            {% for device in devices %}
                <option value="{{ device[0] }}">{{ device[1] }} ({{ device[2] }})</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="acl_name" class="form-label">ACL Name</label>
        <input type="text" class="form-control" id="acl_name" name="acl_name" required>
    </div>
    <div class="mb-3">
        <label for="action" class="form-label">Action</label>
        <select class="form-select" id="action" name="action" required>
            <option value="permit">Permit</option>
            <option value="deny">Deny</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="protocol" class="form-label">Protocol</label>
        <select class="form-select" id="protocol" name="protocol" required>
            <option value="ip">IP</option>
            <option value="tcp">TCP</option>
            <option value="udp">UDP</option>
            <option value="icmp">ICMP</option>
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Source IP</label>
        <div class="input-group">
            <select class="form-select" id="source_type" name="source_type">
                <option value="any">Any</option>
                <option value="host">Host</option>
                <option value="network">Network</option>
            </select>
            <input type="text" class="form-control" id="source_ip" name="source_ip" placeholder="IP address" style="display:none;">
            <input type="text" class="form-control" id="source_wildcard" name="source_wildcard" placeholder="Wildcard mask" style="display:none;">
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Destination IP</label>
        <div class="input-group">
            <select class="form-select" id="destination_type" name="destination_type">
                <option value="any">Any</option>
                <option value="host">Host</option>
                <option value="network">Network</option>
            </select>
            <input type="text" class="form-control" id="destination_ip" name="destination_ip" placeholder="IP address" style="display:none;">
            <input type="text" class="form-control" id="destination_wildcard" name="destination_wildcard" placeholder="Wildcard mask" style="display:none;">
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Add ACL Rule</button>
</form>

<div id="rules_container" class="mt-4">
    <h2>Existing ACL Rules</h2>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ACL Name</th>
                    <th>Sequence</th>
                    <th>Action</th>
                    <th>Protocol</th>
                    <th>Source IP</th>
                    <th>Destination IP</th>
                </tr>
            </thead>
            <tbody id="rules_body">
                {% for rule in initial_rules %}
                <tr>
                    <td>{{ rule.acl_name }}</td>
                    <td>{{ rule.sequence }}</td>
                    <td>{{ rule.action }}</td>
                    <td>{{ rule.protocol }}</td>
                    <td>{{ rule.source_ip }}</td>
                    <td>{{ rule.destination_ip }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>



{% if output %}
<div class="mt-3">
    <h5>Configuration Result</h5>
    <pre>{{ output }}</pre>
</div>
{% endif %}

<script>
    
document.addEventListener('DOMContentLoaded', function() {
    const deviceSelect = document.getElementById('device_id');
    const rulesBody = document.getElementById('rules_body');
    const aclForm = document.getElementById('acl_form');
    const sourceType = document.getElementById('source_type');
    const sourceIp = document.getElementById('source_ip');
    const sourceWildcard = document.getElementById('source_wildcard');
    const destinationType = document.getElementById('destination_type');
    const destinationIp = document.getElementById('destination_ip');
    const destinationWildcard = document.getElementById('destination_wildcard');
  
      function updateIpFields(type, ip, wildcard) {
          if (type.value === 'any') {
              ip.style.display = 'none';
              wildcard.style.display = 'none';
          } else if (type.value === 'host') {
              ip.style.display = 'block';
              wildcard.style.display = 'none';
          } else {
              ip.style.display = 'block';
              wildcard.style.display = 'block';
          }
      }
  
      function updateACLRules() {
    const deviceId = deviceSelect.value;
    fetch(`/show_rules?device_id=${deviceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                rulesBody.innerHTML = '';
                const uniqueAcls = new Set();
                data.rules.forEach(rule => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rule.acl_name}</td>
                        <td>${rule.sequence}</td>
                        <td>${rule.action}</td>
                        <td>${rule.protocol}</td>
                        <td>${rule.source_ip}</td>
                        <td>${rule.destination_ip}</td>
                        <td>
                            <button class="btn btn-danger btn-sm delete-rule" data-acl="${rule.acl_name}" data-sequence="${rule.sequence}">Delete Rule</button>
                        </td>
                    `;
                    rulesBody.appendChild(row);
                    uniqueAcls.add(rule.acl_name);
                });
                
                // Remove existing delete ACL buttons
                const existingDeleteButtons = document.querySelectorAll('.delete-acl-button');
                existingDeleteButtons.forEach(button => button.remove());
                
                // Add delete ACL buttons for unique ACLs
                const deleteAclContainer = document.createElement('div');
                deleteAclContainer.className = 'mt-3';
                uniqueAcls.forEach(aclName => {
                    const deleteAclButton = document.createElement('button');
                    deleteAclButton.textContent = `Delete ACL ${aclName}`;
                    deleteAclButton.className = 'btn btn-danger me-2 mb-2 delete-acl-button';
                    deleteAclButton.addEventListener('click', () => deleteACL(deviceId, aclName));
                    deleteAclContainer.appendChild(deleteAclButton);
                });
                rulesBody.parentNode.parentNode.appendChild(deleteAclContainer);
            } else {
                console.error('Error fetching ACL rules:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}
    function deleteACLRule(deviceId, aclName, sequence) {
        const formData = new FormData();
        formData.append('device_id', deviceId);
        formData.append('acl_name', aclName);
        formData.append('sequence', sequence);

        fetch('/delete_acl_rule', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                updateACLRules();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the ACL rule.');
        });
    }

    function deleteACL(deviceId, aclName) {
        if (confirm(`Are you sure you want to delete the entire ACL ${aclName}?`)) {
            const formData = new FormData();
            formData.append('device_id', deviceId);
            formData.append('acl_name', aclName);

            fetch('/delete_acl', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    updateACLRules();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the ACL.');
            });
        }
    }

    sourceType.addEventListener('change', function() {
        updateIpFields(sourceType, sourceIp, sourceWildcard);
    });

    destinationType.addEventListener('change', function() {
        updateIpFields(destinationType, destinationIp, destinationWildcard);
    });

    deviceSelect.addEventListener('change', updateACLRules);

    // Initial update of IP fields visibility
    updateIpFields(sourceType, sourceIp, sourceWildcard);
    updateIpFields(destinationType, destinationIp, destinationWildcard);

    // Initial load of ACL rules
    updateACLRules();

    // Form submission handler
    aclForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(aclForm);
        
        fetch('{{ url_for("router_acl_config") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                updateACLRules();  // Refresh the ACL rules table
                aclForm.reset();  // Reset the form
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the ACL rule.');
        });
    });

    // Add event listener for delete buttons
    rulesBody.addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-rule')) {
            const aclName = event.target.getAttribute('data-acl');
            const sequence = event.target.getAttribute('data-sequence');
            if (confirm(`Are you sure you want to delete rule ${sequence} from ACL ${aclName}?`)) {
                deleteACLRule(deviceSelect.value, aclName, sequence);
            }
        }
    });
});  </script>
{% endblock %}